<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="bookmark icon" href="https://github.com/kp-marczynski/hitchwiki-poi/blob/master/favicon.png?raw=true"
          type="image/png"/>

    <title>Generate hitchwiki POI</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="https://getbootstrap.com/docs/4.0/examples/floating-labels/floating-labels.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
<div class="form-signin">
    <div class="text-center mb-4">
        <img class="mb-4" src="https://github.com/kp-marczynski/hitchwiki-poi/blob/master/gps_icon.png?raw=true" alt=""
             width="72" height="72">
        <h1 class="h2 mb-3 font-weight-normal">Downloading hitchwiki maps POI points as kml file</h1>
        <p><em>Size of the file is approximately 20Mb</em><br>
            Style of points is compatible with Maps.me&trade; app</p>
    </div>

    <button class="btn btn-lg btn-danger btn-block" type="button" onclick="generatePOI()">Download</button>

    <div class="form-label-group">
        <h2 class="h4 mb-3 font-weight-normal">Download preprocessed places</h2>
        <p><h6><strong>(20 Mb) </strong><em id="knownPlacesUrl"></em></h6></p>
        <div class="progress">
            <div id="knownPlacesBar" class="progress-bar progress-bar-striped active" role="progressbar"
                 aria-valuenow="60"
                 aria-valuemin="0" aria-valuemax="100" style="width:0%">
            </div>
        </div>
    </div>

    <div class="form-label-group">
        <h2 class="h4 mb-3 font-weight-normal">Download countries progress</h2>
        <p><h6><strong>(2 Mb) </strong><em id="countriesUrl"></em></h6></p>
        <div class="progress">
            <div id="countriesBar" class="progress-bar progress-bar-striped active" role="progressbar"
                 aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:0%">
            </div>
        </div>
    </div>

    <div class="form-label-group">
        <h2 class="h4 mb-3 font-weight-normal">Download new places progress</h2>
        <p><h6><em id="placesUrl"></em></h6></p>
        <div class="progress">
            <div id="placesBar" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40"
                 aria-valuemin="0" aria-valuemax="100" style="width:0%">
            </div>
        </div>
    </div>

</div>
<script>

    /* Global variables */
    var kmlTemplate = null;
    var isFileGenerated = false;
    var isAlreadyClicked = false;
    var baseUrl = "https://hitchwiki.org/maps/api/?who=krispy1396&";
    var processedPlaces = 0;
    var processedCountries = 0;
    var numberOfCountries = 0;
    var allPlacesId = [];
    var numberOfPlaces = 0;
    var indexMod = 1000;
    var knownPlaces = null;

    /* Core domain functions */
    function generatePOI() {
        var progressBars = document.getElementsByClassName("progress");
        for (i = 0; i < progressBars.length; ++i) {
            progressBars[i].className = "progress progress-bar-info progress-bar-striped"
        }
        var elem = document.getElementById("knownPlacesBar");
        elem.style.width = '100%';
        if (isFileGenerated) {
            saveToFile();
        } else if (!isAlreadyClicked) {
            var placesUrl = "https://raw.githubusercontent.com/kp-marczynski/hitchwiki-poi/master/all_places_id.json";
            var url = "https://raw.githubusercontent.com/kp-marczynski/hitchwiki-poi/master/world.kml";
            isAlreadyClicked = true;

            document.getElementById("knownPlacesUrl").innerHTML = url;
            console.log("Started downloading known places and known kml");
            httpGetJson(getProxy(placesUrl), setKnownPlaces);
            httpGetJson(getProxy(url), setKnownKml);
        }
    }

    function setKnownPlaces(data) {
        knownPlaces = JSON.parse(data);
        console.log("Known places processed");
    }

    function setKnownKml(data) {
        var elem = document.getElementById("knownPlacesBar");
        elem.innerHTML = knownPlaces.length + "/" + knownPlaces.length;
        elem.className = "progress-bar progress-bar-success";
        kmlTemplate = parseXml(data);
        console.log("Known kml processed");
        getCountries();
    }

    function getCountries() {
        console.log("Gathering countries info");
        var countriesUrl = baseUrl + "countries&format=json";
        httpGetJsonP(countriesUrl, processCountries)
    }

    function processCountries(countries) {
        numberOfCountries = Object.keys(countries).length;
        for (var country in countries) {
            var countryDescriptionUrl = baseUrl + "format=json&country=" + countries[country].iso;
            httpGetJsonP(countryDescriptionUrl, getCountryCallback);
        }
    }

    function getCountryCallback(data, url) {
        processedCountries += 1;
        console.log("Downloaded " + processedCountries + " places out of " + numberOfCountries);
        var percent = Math.floor(processedCountries / numberOfCountries * 100);
        var elem = document.getElementById("countriesBar");
        elem.style.width = percent + '%';
        elem.innerHTML = processedCountries + "/" + numberOfCountries;
        document.getElementById("countriesUrl").innerHTML = url;
        for (i = 0; i < data.length; ++i) {
            var id = data[i]["id"];
            if (knownPlaces.indexOf(id) === -1) {
                console.log("Found unknown id:" + id);
                allPlacesId.push(id);
            }
        }

        if (percent >= 100) {
            console.log("All countries info processed");
            elem.className = "progress-bar progress-bar-success";
            numberOfPlaces = allPlacesId.length;
            movePlacessProccessBar();
            if (numberOfPlaces === 0) {
                saveToFile();
            } else {
                console.log("Gathering info about unknown places");
                getPlaces(processedPlaces);
            }
        }

    }

    function getPlaces(startIndex) {
        var endIndex = (startIndex + indexMod < numberOfPlaces) ? startIndex + indexMod : numberOfPlaces;
        console.log("Start index: " + startIndex + ", End index: " + endIndex);

        for (i = startIndex; i < endIndex; i++) {
            var url = baseUrl + "format=kml&place=" + allPlacesId[i];
            document.getElementById("placesUrl").innerHTML = url;
            httpGetJson(getProxy(url), getPlacesCallback);
        }
    }

    function getPlacesCallback(data) {
        addPlacemarkToTemplate(parseXml(data));
        processedPlaces += 1;
        console.log("Downloaded " + processedPlaces + " places out of " + numberOfPlaces);
        movePlacessProccessBar();
        if (processedPlaces >= numberOfPlaces) {
            console.log("All unknown places processed");
            saveToFile();
        } else if (processedPlaces % indexMod === 0) {
            getPlaces(processedPlaces);
        }
    }

    function saveToFile() {
        isFileGenerated = true;
        console.log("Saving to file");

        var filename = "world.kml";
        var pom = document.createElement('a');
        var bb = new Blob([new XMLSerializer().serializeToString(kmlTemplate)], {type: 'application/vnd.google-earth.kml+xml'});

        pom.setAttribute('href', window.URL.createObjectURL(bb));
        pom.setAttribute('download', filename);

        pom.dataset.downloadurl = ['application/vnd.google-earth.kml+xml', pom.download, pom.href].join(':');
        pom.draggable = true;
        pom.classList.add('dragout');

        pom.click();
    }

    /* Utils domain functions */
    function getKmlTemplate() {
        return parseXml('<kml xmlns="https://earth.google.com/kml/2.2"><Document><Style id="placemark-blue"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-blue.png</href></Icon></IconStyle></Style><Style id="placemark-brown"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-brown.png</href></Icon></IconStyle></Style><Style id="placemark-green"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-green.png</href></Icon></IconStyle></Style><Style id="placemark-orange"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-orange.png</href></Icon></IconStyle></Style><Style id="placemark-pink"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-pink.png</href></Icon></IconStyle></Style><Style id="placemark-purple"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-purple.png</href></Icon></IconStyle></Style><Style id="placemark-red"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-red.png</href></Icon></IconStyle></Style><Style id="placemark-yellow"><IconStyle><Icon><href>https://mapswith.me/placemarks/placemark-yellow.png</href></Icon></IconStyle></Style><name>World</name><visibility>1</visibility></Document></kml>');
    }

    function replaceStyleUrl(styleUrl) {
        switch (styleUrl.nodeValue) {
            case "#rating_0":
                styleUrl.nodeValue = "#placemark-purple";
                break;
            case "#rating_1":
                styleUrl.nodeValue = "#placemark-green";
                break;
            case "#rating_2":
                styleUrl.nodeValue = "#placemark-blue";
                break;
            case "#rating_3":
                styleUrl.nodeValue = "#placemark-yellow";
                break;
            case "#rating_4":
                styleUrl.nodeValue = "#placemark-orange";
                break;
            case "#rating_5":
                styleUrl.nodeValue = "#placemark-red";
                break;
            default:
                styleUrl.nodeValue = "#placemark-brown";
                break;
        }
    }

    function addPlacemarkToTemplate(somePLace) {
        replaceStyleUrl(somePLace.getElementsByTagName("styleUrl")[0].childNodes[0]);
        kmlTemplate.getElementsByTagName("Document")[0].appendChild(somePLace.getElementsByTagName("Placemark")[0]);
    }

    function movePlacessProccessBar() {
        var percent = 0;
        if (numberOfPlaces > 0) {
            percent = Math.floor(processedPlaces / numberOfPlaces * 100);
        }
        else {
            percent = 100
        }
        var elem = document.getElementById("placesBar");
        elem.style.width = percent + '%';
        elem.innerHTML = processedPlaces + "/" + numberOfPlaces;
        if (percent >= 100) {
            elem.className = "progress-bar progress-bar-success";
        }
    }

    /* Helper functions */
    function httpGetJson(url, callback) {
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open("GET", url, true);
        xmlHttp.onload = function () {
            var resp = JSON.parse(xmlHttp.responseText);
            callback(resp["body"]);
        };
        xmlHttp.send(null);
    }

    function httpGetJsonP(url, callback) {
        $.ajax({
            type: 'GET',
            url: url,
            dataType: 'jsonp',
            async: true,
            crossDomain: true
        }).done(function (data) {
            callback(data, url);
        });
    }

    function parseXml(string) {
        parser = new DOMParser();
        return parser.parseFromString(string, "text/xml");
    }

    function getProxy(url) {
        return "http://cors-proxy.htmldriven.com/?url=" + encodeURIComponent(url);
    }

</script>
</body>
</html>